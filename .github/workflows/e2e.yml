name: E2E Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  e2e-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # v4.1.7
        timeout-minutes: 5

      - name: Set up Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed  # v5.1.0
        timeout-minutes: 5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af  # v4.1.0
        timeout-minutes: 5
        with:
          node-version: '20'

      - name: Install Bun (Linux)
        if: runner.os == 'Linux'
        timeout-minutes: 5
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install Bun (macOS)
        if: runner.os == 'macOS'
        timeout-minutes: 5
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Install Bun (Windows)
        if: runner.os == 'Windows'
        timeout-minutes: 5
        run: |
          powershell -c "irm bun.sh/install.ps1|iex"
          echo "$env:USERPROFILE\.bun\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install pnpm
        timeout-minutes: 5
        run: npm install -g pnpm

      - name: Install osquery (Linux)
        if: runner.os == 'Linux'
        timeout-minutes: 10
        run: |
          # Add osquery repository
          curl -L https://pkg.osquery.io/deb/pubkey.gpg | sudo gpg --dearmor -o /usr/share/keyrings/osquery-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/osquery-archive-keyring.gpg] https://pkg.osquery.io/deb deb main" | sudo tee /etc/apt/sources.list.d/osquery.list
          sudo apt-get update
          sudo apt-get install -y osquery

      - name: Install osquery (macOS)
        if: runner.os == 'macOS'
        timeout-minutes: 10
        run: |
          brew install --cask osquery

      - name: Install osquery (Windows)
        if: runner.os == 'Windows'
        timeout-minutes: 10
        run: |
          choco install osquery -y

      - name: Build extension
        timeout-minutes: 10
        run: go build -v -o node_packages_extension${{ runner.os == 'Windows' && '.exe' || '' }} .

      - name: Setup test environment
        timeout-minutes: 10
        run: |
          mkdir -p test-packages
          cd test-packages

          # npm packages
          npm init -y
          npm install react react-dom lodash

          # pnpm packages
          pnpm add express axios

          # bun packages (skip on Windows for now due to potential issues)
          if [ "${{ runner.os }}" != "Windows" ]; then
            bun add typescript @types/node
          fi
        shell: bash

      - name: Run E2E tests
        timeout-minutes: 15
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            EXTENSION_PATH="./node_packages_extension.exe"
          else
            EXTENSION_PATH="./node_packages_extension"
          fi

          # Set proper permissions for osquery security requirements
          chmod 755 "$EXTENSION_PATH"

          # On Linux/macOS, change owner to root (required by osquery)
          if [ "${{ runner.os }}" == "macOS" ]; then
            sudo chown root:wheel "$EXTENSION_PATH"
          elif [ "${{ runner.os }}" == "Linux" ]; then
            sudo chown root:root "$EXTENSION_PATH"
          fi

          # Debug: Check osquery version and extensions
          echo "=== osquery version ==="
          osqueryi --version || echo "osqueryi --version failed"

          echo "=== Extension path and permissions ==="
          ls -lh "$EXTENSION_PATH"

          # Debug: Try to run extension directly to see if it starts
          echo "=== Testing extension binary directly ==="
          "$EXTENSION_PATH" --help || echo "Extension help failed"

          # Test extension in background to check if it stays running
          echo "=== Testing extension stays running ==="
          "$EXTENSION_PATH" --socket /tmp/test.em --verbose &
          EXT_PID=$!
          sleep 2
          if ps -p $EXT_PID > /dev/null; then
            echo "Extension process is running (PID: $EXT_PID)"
            kill $EXT_PID
          else
            echo "Extension process exited unexpectedly"
          fi

          # Debug: Check if extension can be loaded
          echo "=== Checking if extension loads ==="
          osqueryi --extension "$EXTENSION_PATH" --ephemeral --extensions_timeout 10 --verbose --json "SELECT * FROM osquery_extensions;" 2>&1 | tee extension_check.json
          echo "Extension check done"

          # Test 1: Query all packages (with extension timeout)
          echo "=== Test 1: Querying all packages ==="
          osqueryi --extension "$EXTENSION_PATH" --ephemeral --extensions_timeout 10 --verbose --json "SELECT * FROM node_packages;" 2>&1 | tee results.json

          EXIT_CODE=${PIPESTATUS[0]}
          echo "Exit code: $EXIT_CODE"

          # Check if JSON array is returned
          if grep -q '^\[' results.json; then
            echo "Valid JSON array returned"
            # Count packages found
            PACKAGE_COUNT=$(grep -o '"name"' results.json | wc -l | tr -d ' ')
            echo "Found $PACKAGE_COUNT package entries"

            # Success even if no packages (CI environment might be empty)
            if [ "$PACKAGE_COUNT" -eq 0 ]; then
              echo "Warning: No packages found in CI environment (this is OK)"
            fi
          else
            echo "Error: Invalid JSON array format or query failed"
            echo "Results content:"
            cat results.json
            exit 1
          fi
        shell: bash

      - name: Run additional test queries (Linux/macOS)
        if: runner.os != 'Windows'
        timeout-minutes: 10
        run: |
          # Test 2: Manager-specific queries
          echo "Test 2: Querying npm packages..."
          osqueryi --extension ./node_packages_extension \
            --ephemeral \
            --extensions_timeout 10 \
            --json \
            "SELECT name, version, manager FROM node_packages WHERE manager = 'npm';" 2>&1 | tee npm_packages.json || true

          # Test 3: Count by manager
          echo "Test 3: Counting packages by manager..."
          osqueryi --extension ./node_packages_extension \
            --ephemeral \
            --extensions_timeout 10 \
            --json \
            "SELECT manager, COUNT(*) as count FROM node_packages GROUP BY manager;" 2>&1 | tee manager_counts.json || true

          # Display results
          echo "=== NPM Packages ==="
          cat npm_packages.json || echo "No npm packages file"

          echo "=== Manager Counts ==="
          cat manager_counts.json || echo "No manager counts file"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.os }}
          path: |
            results.json
            npm_packages.json
            manager_counts.json
          retention-days: 7
